const fs = require("fs");

const quotes = fs
  .readFileSync("./data/quotes.html")
  .toString()
  .split("<h1>")
  .filter(Boolean)
  .map((chunk) => `<h1>${chunk}`);

const inserts = [];

const pgEscape = (str) => {
  return str.replace(/'/g, "''");
};

for (const quote of quotes) {
  const titleHtml = /<h1>([\s\S]+)<\/h1>/.exec(quote)[1].replaceAll("\n", "");
  const title = titleHtml.match(/>([^<]*)</)[1]; // eg. "The Eternal Enemy: Complexity"
  inserts.push(
    `INSERT INTO quotes (name, body_html) VALUES ('${pgEscape(
      title
    )}', '${pgEscape(quote)}');`
  );
}

const tmpl = `-- This file was generated by running \`node generate-sql-migration.sh\`
-- There may be some bugs in it, I dunno.

DROP SEQUENCE IF EXISTS quotes_id_seq CASCADE;
DROP TABLE IF EXISTS quotes CASCADE;

CREATE TABLE quotes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(256),
    body_html TEXT,
    UNIQUE(name)
);

ALTER SEQUENCE quotes_id_seq RESTART WITH 50;

${inserts.join("\n\n")}
`;

fs.writeFileSync("init.sql", tmpl);
console.log("Wrote init.sql");
